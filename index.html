<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>AI 視訊聊天 Demo</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 320px; height: auto; border: 2px solid #ccc; margin-top: 1em; }
    #chatbox { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>AI 視訊聊天</h1>
  <video id="video" autoplay muted></video>
  <div id="chatbox">
    <p><strong>AI：</strong><span id="ai-response">（等待分析中...）</span></p>
  </div>

  <script>
    const video = document.getElementById('video');
    const aiResponse = document.getElementById('ai-response');

    // 啟動鏡頭
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error('無法開啟鏡頭', err));

    // 載入模型
    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models'),
      faceapi.nets.ageGenderNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models'),
      faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models')
    ]).then(startDetection);

    // 啟動臉部分析
    async function startDetection() {
      const options = new faceapi.TinyFaceDetectorOptions();
      setInterval(async () => {
        const result = await faceapi.detectSingleFace(video, options)
          .withAgeAndGender()
          .withFaceExpressions();
        if (result) {
          const { age, gender, expressions } = result;
          const topExpr = Object.entries(expressions).reduce((a, b) => a[1] > b[1] ? a : b)[0];
          const prompt = `根據下列資訊：一位大約 ${Math.round(age)} 歲的 ${gender === 'male' ? '男性' : '女性'}，臉部表情看起來是 ${translateExpression(topExpr)}，請用一句親切自然的中文跟他打招呼。`;
          console.log(prompt);
          fetchGPT(prompt);
        }
      }, 8000); // 每 8 秒分析一次
    }

    // 表情翻譯
    function translateExpression(expr) {
      const map = {
        happy: '開心',
        sad: '難過',
        angry: '生氣',
        surprised: '驚訝',
        neutral: '平靜',
        fearful: '害怕',
        disgusted: '厭惡'
      };
      return map[expr] || expr;
    }

    // 呼叫 OpenAI ChatGPT API
    async function fetchGPT(prompt) {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer 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", // 替換成你的 API 金鑰
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
          temperature: 0.7
        })
      });
      const data = await response.json();
      const reply = data.choices?.[0]?.message?.content || '無回應';
      aiResponse.textContent = reply;
      speak(reply);
    }

    // 語音朗讀
    function speak(text) {
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'zh-TW';
      synth.speak(utter);
    }
  </script>
</body>
</html>
